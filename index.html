<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'none'; object-src 'none'; frame-src 'none'">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <title>CTF Challenge Arena</title>
  <script src="https://cdn.tailwindcss.com" integrity="sha384-4f6b2f3+W6A2f5b2f3+W6A4f5b2f4c3+W6A4f5b2f4d3" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js" integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6enlHGFK8fLWYxY6iW2f3+W6A4f5b2f4c3" crossorigin="anonymous"></script>
  <style>
    body {
      background-color: #000;
      color: #333;
      font-family: monospace;
    }
    .card {
      transition: all 0.2s;
      background-color: #222;
      border: 2px solid #444;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .solved {
      border-color: #2a2;
      opacity: 0.7;
    }
    .hidden { display: none; }
    #hidden-flag { content: "flag{source_hunt}";
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;    background-color: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background-color: #111;
      padding: 15px;
      border-radius: 5px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #444;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2">
  <div class="w-full max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-3 text-blue-300">CTF Challenge Arena</h1>
    <p class="text-center mb-3 text-sm">Solve challenges sequentially. Flags: <code>flag{...}</code>.</p>
    <p class="text-center mb-4 text-lg text-green-300">Score: <span id="score">0</span></p>
    <div id="challenges" class="space-y-4"></div>
  </div>

  <div id="hint-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title" class="text-xl text-blue-200 mb-3"></h2>
      <div id="modal-content" class="mb-3 text-sm"></div>
      <button onclick="closeModal()" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded text-sm">Close</button>
    </div>
  </div>

  <script src="challenges.js"></script>
  <script src="feedback.js"></script>
  <script>
    const SECRET_KEY = 'ctf_secure_2025';
    const HMAC_SECRET = 'ctf_hmac_2025';

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function encryptData(data) {
      return CryptoJS.AES.encrypt(JSON.stringify(data), SECRET_KEY).toString();
    }

    function decryptData(encrypted) {
      try {
        const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
        return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
      } catch (e) {
        return null;
      }
    }

    function getHMAC(data) {
      return CryptoJS.HmacSHA256(JSON.stringify(data), HMAC_SECRET).toString();
    }

    function validateState(data, hmac) {
      return getHMAC(data) === hmac;
    }

    let solvedChallenges = [];
    let score = 0;
    let incorrectAttempts = {};

    function loadState() {
      const encData = localStorage.getItem('ctf_state');
      const hmac = localStorage.getItem('ctf_hmac');
      if (encData && hmac) {
        const data = decryptData(encData);
        if (data && validateState(data, hmac)) {
          solvedChallenges = data.solved || [];
          score = data.score || 0;
        } else {
          resetState();
        }
      }
    }

    function saveState() {
      const data = { solved: solvedChallenges, score };
      const encData = encryptData(data);
      const hmac = getHMAC(data);
      localStorage.setItem('ctf_state', encData);
      localStorage.setItem('ctf_hmac', hmac);
    }

    function resetState() {
      solvedChallenges = [];
      score = 0;
      saveState();
    }

    function updateScoreDisplay() {
      const scoreEl = document.getElementById('score');
      if (scoreEl) scoreEl.textContent = sanitizeInput(score.toString());
    }

    function initializeChallenges() {
      if (window.challenges && Array.isArray(window.challenges)) {
        const cookieChallenge = window.challenges.find(c => c.id === 3);
        if (cookieChallenge && cookieChallenge.setup) {
          try {
            cookieChallenge.setup();
          } catch (e) {
            console.error('Challenge 3 init failed:', e);
          }
        }
      }
    }

    function renderChallenges() {
      const challengesDiv = document.getElementById('challenges');
      if (!challengesDiv) return;
      challengesDiv.innerHTML = '';
      if (!window.challenges || !Array.isArray(window.challenges)) {
        challengesDiv.innerHTML = '<p class="text-red-300 text-center text-sm">Error: Challenges not loaded.</p>';
        console.error('Challenges invalid:', window.challenges);
        return;
      }
      window.challenges.forEach(challenge => {
        const isUnlocked = challenge.id === 1 || solvedChallenges.includes(challenge.id - 1);
        const isSolved = solvedChallenges.includes(challenge.id);
        const card = document.createElement('div');
        card.className = `card bg-gray-900 p-4 rounded shadow ${isUnlocked ? '' : 'opacity-50 pointer-events-none'} ${isSolved ? 'solved' : ''}`;
        card.innerHTML = `
          <h2 class="text-lg font-semibold text-blue-200">${sanitizeInput(challenge.title)} (${sanitizeInput(challenge.points.toString())} pts)</h2>
          <p class="mt-1 text-sm">${sanitizeInput(challenge.description)}</p>
          ${isUnlocked ? `
            ${isSolved ? '<p class="mt-1 text-green-300 text-sm font-bold">Solved!</p>' : `
              <p class="mt-1 text-blue-300 cursor-pointer underline text-sm" onclick="showHint(${challenge.id})">Hint</p>
              <input id="flag-${challenge.id}" type="text" placeholder="flag{...}" class="mt-2 w-full p-1 bg-gray-800 text-white rounded text-sm" ${isSolved ? 'disabled' : ''}>
              <button onclick="submitFlag(${challenge.id})" class="mt-1 px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded text-sm" ${isSolved ? 'disabled' : ''}>Submit</button>
              <p id="feedback-${challenge.id}" class="mt-1 text-xs"></p>
            `}
          ` : `<p class="mt-1 text-red-300 text-sm">Solve Challenge ${challenge.id - 1}</p>`}
        `;
        challengesDiv.appendChild(card);
      });
      updateScoreDisplay();
    }

    function submitFlag(challengeId) {
      const challenge = window.challenges.find(c => c.id === challengeId);
      if (!challenge) return;
      const input = sanitizeInput(document.getElementById(`flag-${challengeId}`).value);
      try {
        if (challenge.validator(input)) {
          showConfirmation(`Correct! +${challenge.points} pts`, true);
          if (!solvedChallenges.includes(challengeId)) {
            solvedChallenges.push(challengeId);
            score += challenge.points;
            saveState();
            incorrectAttempts[challengeId] = 0;
            renderChallenges();
          }
        } else {
          incorrectAttempts[challengeId] = (incorrectAttempts[challengeId] || 0) + 1;
          const msg = 'Incorrect flag!';
          showConfirmation(msg, false, incorrectAttempts[challengeId] >= 3 ? getInstructions(challengeId) : null);
        }
      } catch (e) {
        console.error(`Validation error ${challengeId}:`, e);
        showConfirmation('Validation error.', false);
      }
    }

    function checkIntegrity() {
      const expected = CryptoJS.SHA256(submitFlag.toString()).toString();
      const current = CryptoJS.SHA256(submitFlag.toString()).toString();
      if (expected !== current) {
        window.location.href = '/tamper.html';
      }
    }

    (function() {
      const check = () => {
        if ((window.outerWidth - window.innerWidth > 100) || (window.outerHeight - window.innerHeight > 100)) {
          window.location.href = '/devtools.html';
        }
        console.warn('DevTools detected.');
      };
      setInterval(check, 500);
      setInterval(checkIntegrity, 1000);
    })();

    window.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('keydown', e => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'C', 'J'].includes(e.key))) {
        e.preventDefault();
        window.location.href = '/devtools.html';
      }
    });

    try {
      loadState();
      initializeChallenges();
      renderChallenges();
    } catch (e) {
      console.error('Init failed:', e);
      document.getElementById('challenges').innerHTML = '<p class="text-red-300 text-center text-sm">Error loading.</p>';
    }
  </script>
</body>
</html>
